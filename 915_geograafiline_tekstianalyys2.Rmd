# Geograafiline tekstianalüüs (2) {#tekstianalyys2}

Tänases praktikumis tegeleme geograafilise tekstianalüüsiga, katsetades eesti keele automaattöötluseks loodud vahendeid. Nagu eelmises praktikumis mainitud, sisaldub selleks kõige põhjalikum tööriistade komplekt Pythoni **EstNLTK** teekides.

Kasutame geograafilise tekstianalüüsi näitlikustamiseks [Riigikogu istungite stenogramme](https://stenogrammid.riigikogu.ee/et). Selle praktikumi jaoks oleme kraapinud veebist nende istungite protokollid, mis on toimunud vahemikus 01.01.2020 ja 01.11.2022. 

```{r echo=F, fig.show='hold', fig.align='center', out.width= "80%", fig.cap= "Riigikogu istungite stenogrammid veebilehel"}
knitr::include_graphics(here::here("imgs", "15_stenogrammid.png"))
```

Kõik protokollid on Moodle'is praktikumi materjalide kaustas eraldi alamkaustas nimega **_stenogrammid.zip_**. Samuti on materjalide hulgas kraapimiseks kasutatud R-i skript.


Tänases ülesandes 

1. leiame, **milliseid kohanimeüksusi** on istungi protokollis mainitud;  
2. analüüsime, milline on kohanimeüksust sisaldava **tekstikatkendi meelsus**: kas tekst on pigem positiivne, negatiivne või neutraalne;  
3. **puhastame** andmestiku;  
4. **geokodeerime** kohanimeüksused;  
5. **visualiseerime** andmeid.  


## Kohanimeüksuste ja tekstikatkendite meelsuse tuvastamine

Kohanimeüksuste automaatseks tuvastamiseks ning nende vahetu konteksti eraldamiseks tekstist kasutame EstNLTK analüüsivahendeid. Selleks, et Pythoni installimiselt ning skriptide kirjutamiselt aega kokku hoida, kasutame praktikumis **[Google Colabi](https://colab.research.google.com/drive/1K8wftl_g9PC9psobw9-lcUwoF1ukM90y?usp=sharing)**, mille kaudu saame jooksutada juba valmis kirjutatud skripti. Kui soovid eesti keele automaattöötluse kohta rohkem õppida, on suureks abiks [EstNLTK õppematerjalid](https://github.com/estnltk/estnltk) (kaustas *tutorials*) ja TÜ kursus "[Eesti keele töötlus Pythonis](https://github.com/d009/EstNLP)".

Meelsusanalüüsiks kasutame siin Eesti Keele Instituudi [emotsioonidetektorit](http://peeter.eki.ee:5000/valence), mille aluseks olev Pythoni kood on üleval GitHubi lehel https://github.com/EKT1/valence/. Sama kausta materjalid on ka Moodle'is failis *valence-master.zip*. Emotsioonidetektori kohta saad lugeda artiklist *[Pajupuu, Hille; Altrov, Rene; Pajupuu, Jaan (2016). Identifying polarity in different text types. Folklore. Electronic Journal of Folklore, 64, 25−42](http://www.folklore.ee/folklore/vol64/polarity.pdf)*.

Koodi jooksutamiseks vajuta koodiplokkide vasakus servas oleval noolekesel. Kui midagi skripti jooksutamisel ei tööta, on praktikumi materjalides kaasas ka ühe näidisfaili (*202106091400.csv*) analüüsid (kaustas *kohanimed_valmis*). 

```{r, echo = F, message = F, warning = F}
dat <- read.delim("data/praktikum_15_andmed/kohanimed_valmis/istung.csv", sep = "\t", encoding = "UTF-8")
knitr::kable(head(dat))
```



Skripti väljundiks on fail **_istung.csv_**, kus on tabelkujul  

- kohanimeüksus sellisel kujul, nagu see tekstis esineb (tulp `kohanime_vorm`);  
- kohanimeüksuse algvorm (tulp `kohanime_lemma`), mitmesõnalise kohanimeüksuse puhul on lemmatiseeritud ainult nimeüksuse viimane sõna (nt `Tallinna linn`);  
- kontekst ehk 20 sõna kohanimest vasakule ja paremale (tulp `kontekst`);  
- kontekstile määratud meelsuse hinnang (tulp `meelsus`).  

Loeme tabeli Excelisse või muusse tabeltöötlusprogrammi: 

- *Data → From Text/CSV* → *File Origin: UTF-8*, *Delimiter: Tab* → *Transform Data* → vajuta *Use First Row as Headers* → *Close & Load*).  


Hindame nimetuvastuse kvaliteeti. On teada, et automaatne nimetuvastus töötab kõige paremini isikunimede tuvastamisega, kohanimede ja organisatsioonidega on sel rohkem raskusi.  
Võime andmeid pisut käsitsi puhastada ja korrastada. Kustutame tabelist read, kus nimetuvastus on eksinud (nt *Facebook*, *Euroopa Liit*), parandame kohanimede lemmasid (nt *pai* → *Paide*).

Salvestame Exceli tabeli nimega **_istung.xlsx_**.  


## Tekstikatkendi meelsuse tuvastamine Excelis

EKI emotsioonidetektor on tegelikult kasutatav ka MS Exceli laiendusena (*Add-in*), ent see ei pruugi uuemates Exceli versioonides alati töötada. Katsetame.  

- Laadime lehelt http://peeter.eki.ee:5000/applications/list alla faili *[valence.xlam](http://peeter.eki.ee:5000/valence.xlam)*.  
- Otsime Excelist üles *File → Options → Add-ins → Manage Excel Add-ins → Go → Browse*, otsime üles faili *valence.xlam*.  
- Kirjutame Excelis tabeli uude tulpa `=Valence.TestBayes()` ja sulgude vahele lahtri viite, milles on tekst (nt `=Valence.TestBayes(C2)`). Kontrollime, kas tulemused vastavad Pythoni skriptiga saadud tulemustele.  


## Koordinaatide lisamine (geokodeerimine)

Nüüd peame saama oma tabelile koordinaadid. Selleks võiksime proovida põhimõtteliselt kasutada ka [Maa-ameti geokodeerimise teenust](https://inaadress.maaamet.ee/geocoder/one#/), aga kuna teame, et meie tabelis on palju ka välisriikide kohanimesid, ei oleks sellest väga palju kasu. Katsetame niisiis hoopis QGISi geokodeerijat.   
Esmalt salvestame xlsx-faili csv-na, nt nimega **_istung_parandatud.csv_**. Geokodeerimise jaoks oleks vaja, et faili kodeering oleks UTF-8.     

Seejärel  

- avame QGISi,  
- otsime sobiva aluskaardi ja CRS-i,  
- laadime csv-faili QGISi,  
- valime *Processing → Toolbox → Vector general → Batch Nominatim geocoder*, *Input layer* on csv-faili kiht, mille just laadisime, *Address field* on *kohanime_lemma*.  


```{r echo=F, fig.show='hold', fig.align='center', out.width= "60%", fig.cap= "Tuvastatud kohanimede geokodeerimine QGISis"}
knitr::include_graphics(here::here("imgs", "15_geokodeerimine.png"))
```

Nimetame kihi *Geocoded* ümber nimega **_istungi_kohad_**.  



## Visualiseerimine


### Mainimiste arv {-}

Vaatame esmalt, milliseid kohti ja kui palju mainiti. Selleks on teatavasti mitu võimalust:  

- muudame punktide läbipaistvust (rohkem mainitud kohad jäävad tumedamalt);  
- valime *Symbology* jaotises *Single symbol* asemel *Point Cluster* või *Point Displacement*;  
- valime *Symbology* jaotises *Heatmap*, valime sobiva värvipaleti ja -skaala.  


```{r echo=F, fig.show='hold', fig.align='center', out.width= "70%", fig.cap= "Stenogrammis mainitud kohanimede *heatmap*"}
knitr::include_graphics(here::here("imgs", "15_heatmap.png"))
```


Võime ka teha uue kihi, kus loeme kokku, kui mitu punkti ühe nimega mainitakse, ja visualiseerida mainimiste arvu näiteks punkti suuruse abil. Selleks valime *Database → DB Manager → SQL Window* ja päringu aknasse kirjutame 
```
SELECT kohanime_lemma, COUNT(kohanime_lemma) AS arv, geometry
FROM istungi_kohad
GROUP BY kohanime_lemma;
```

Vajutame *Execute*, teeme linnukese kasti *Load as new layer* ette ja vajutame *Load*. Uuel kihil vajutame *Size* paremas ääres kastikest, valime *Expression → Edit* ja kirjutame avaldiseks `log10("arv")*10`. Logaritmimine vähendab erinevusi suurt arvude vahel ja toob esile erinevusi väiksemate arvude vahel.


### Emotsioonid {-}

Kasutame punktide asemel diagramme, et visualiseerida, kui suur protsent mingi koha mainimistest olid positiivses, negatiivses ja neutraalses kontekstis. Selleks tuleb esmalt teha kiht, kus oleme kokku lugenud iga koha iga emotsiooni mainimiste arvu ja pannud selle eraldi tulpadesse.

*Database → DB Manager → SQL Window* ja päringu aknasse kirjutame  

```
SELECT kohanime_lemma, geometry,
SUM(CASE WHEN meelsus = 'positive' THEN 1 ELSE 0 END) AS positive,
SUM(CASE WHEN meelsus = 'negative' THEN 1 ELSE 0 END) AS negative,
SUM(CASE WHEN meelsus = 'neutral' THEN 1 ELSE 0 END) AS neutral
FROM istungi_kohad
GROUP BY kohanime_lemma;  
```


- Uue tekkinud kihi *Symbology* jaotises valime *Single symbol* asemel *No symbols*.    
- Lisame pirukadiagrammid (*Diagrams → Pie Chart*),  
    + atribuutideks valime tulbad *positive*, *negative* ja *neutral*,  
    + neile kategooriatele valime sobivad värvid,  
    + muudame diagrammid veidi läbipaistvamaks (*Rendering → Opacity*)  
    + ja diagrammide suuruseks määrame *Scaled size*, 
        - *Attribute* väärtuseks `"positive"+"negative"+"neutral"`   
        - ja valime sobiva skaala, arvestades kõige sagedamini mainitud koha mainimiste arvu ja kõige harvemini mainitud kohtade arvu.   
    + paneme diagrammid punktide koha peale: *Placement → Over point*.  


```{r echo=F, fig.show='hold', fig.align='center', out.width= "70%", fig.cap= "Positiivsete, negatiivsete ja neutraalsete mainimiste osakaalud"}
knitr::include_graphics(here::here("imgs", "15_diagrams.png"))
```


Määrame lõpuks ka kohanimedele sildid, mis tuleksid nähtavale alles siis, kui oleme piisavalt sisse suuminud.

*Symbology → Labels → Single labels → Rendering → Scale Dependent Visibility*. Teeme ka linnukese valiku *Show all labels for this layer* ette.  


## Järgmisel korral

Geostatistika.
